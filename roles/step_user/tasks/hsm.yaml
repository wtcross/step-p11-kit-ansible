---
- name: Create udev rules to allow the {{ _step_group }} group to interact with the HSM
  become: true
  ansible.builtin.template:
    src: udev/99-step-hsm.rules.j2
    dest: /etc/udev/rules.d/99-step-hsm.rules
    owner: root
    group: root
    mode: "0644"
  register: create_hsm_udev_rule

- name: Reload udev rules if 99-step-hsm.rules changed
  when: create_hsm_udev_rule.changed
  become: true
  ansible.builtin.command:
    argv:
      - /sbin/udevadm
      - control
      - --reload-rules
  register: reload_udev_rules

- name: Trigger udev events if 99-step-hsm.rules changed and udev rules were reloaded
  when: create_hsm_udev_rule.changed and reload_udev_rules.rc == 0
  become: true
  ansible.builtin.command:
    argv:
      - /sbin/udevadm
      - trigger
      - --attr-match=idVendor={{ step_hsm_vendor_id }}
      - --attr-match=idProduct={{ step_hsm_product_id }}

- name: Create a polkit rule that allows the {{ _step_group }} group to interact with the HSM
  become: true
  ansible.builtin.template:
    src: polkit/50-step-pcsc.rules.j2
    dest: /etc/polkit-1/rules.d/50-step-pcsc.rules
    owner: root
    group: root
    mode: "0644"
  notify: Restart polkit

- name: Ensure pcscd is started and enabled
  become: true
  ansible.builtin.systemd_service:
    state: started
    enabled: true
    name: pcscd
    scope: system
