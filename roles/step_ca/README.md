# step_ca

Deploys `step-ca-p11-kit` as a rootless, user-scoped systemd quadlet with PKCS#11 remoting via `p11-kit server`.

## Requirements

- `wtcross.step.step_host` should be applied first (host packages and SELinux policy setup)
- `wtcross.step.step_user` should be applied first
- `cosign` must be installed on the target host (managed by `wtcross.step.step_host`)
- User configured as `ansible_user` must be able to become `root`
- Controller running the playbook must be able to reach GitHub raw content

## Upstream Asset Source

This role does not template quadlet/systemd unit files directly.
It pulls files from the `step-p11-kit-images` repository using a pinned default ref and copies them to the target user's config directories:

- `deploy/systemd/*`
- `scripts/generate-instance-env.sh`
- `scripts/common/{validation.sh,logging.sh}`

## Role Variables

### Required

| Variable | Description |
| --- | --- |
| `step_ca_name` | CA name used for initialization |
| `step_ca_dns_names` | CA DNS names (list or comma-separated string) |
| `step_ca_host_private_key_pkcs11_uri` | Host PKCS#11 URI for the CA private key (must include `module-path`, `token`, `id`) |
| `step_ca_root_cert_local_path` | Path on the Ansible controller for the root cert PEM |
| `step_ca_cert_local_path` | Path on the Ansible controller for the step-ca cert PEM |

Preflight validation enforces all of the following:

- `cosign` is installed on the target host.
- Every value in `step_ca_dns_names` is present as a DNS SAN entry in the certificate read from `step_ca_cert_local_path`.

The role parses `step_ca_host_private_key_pkcs11_uri` and derives all PKCS#11 URIs needed for:

- host-side `p11-kit server` token remoting
- in-container private-key operations

If present, `object` and `type` from the host URI are preserved in the derived in-container private-key URI.

### Optional

| Variable | Description | Default |
| --- | --- | --- |
| `step_ca_instance` | Instance name used in systemd template units | Derived from `step_ca_name` |
| `step_ca_https_port` | Host TCP port published to the step-ca listener port inside the container | `9000` |
| `step_ca_admin_subject` | Admin subject for initial provisioner | `step` |
| `step_ca_admin_provisioner_name` | Initial admin provisioner name | `admin` |
| `step_ca_steppath` | `STEPPATH` inside container | `/home/step/.step` |
| `step_ca_images_repo_owner` | GitHub owner for upstream asset source | `wtcross` |
| `step_ca_images_repo_name` | GitHub repo for upstream asset source | `step-p11-kit-images` |
| `step_ca_images_repo_ref` | Git ref/branch/tag for upstream assets | `main` |
| `step_ca_rotate_cert_secrets` | Recreate cert Podman secrets when source certs change | `true` |
| `step_ca_force_prompt_hsm_pin` | Always prompt for `hsm-pin` and replace secret | `false` |
| `step_ca_force_prompt_admin_password` | Always prompt for `admin-password` and replace secret | `false` |
| `step_user` | Service account user name | `step` |
| `step_group` | Service account group name | `step` |
| `step_uid` | Service account UID | `1001` |

## Secret Handling

The role ensures these Podman secrets exist (instance-scoped):

- `hsm-pin-<instance>`
- `admin-password-<instance>`
- `root-cert-<instance>`
- `cert-<instance>`

Behavior:

- `hsm-pin` and `admin-password` are prompted interactively when missing.
- `step_ca_force_prompt_hsm_pin: true` forces reprompt and replacement.
- `step_ca_force_prompt_admin_password: true` forces reprompt and replacement.
- Cert secrets are created from controller-local cert files.
- Cert secrets are rotated when source cert content changes (unless rotation is disabled).
- Secret changes notify a restart of `step-ca-p11-kit@<instance>.service`.

## Systemd Units and Env Files

Installed user-scoped units:

- `~/.config/containers/systemd/step-ca-p11-kit@.container`
- `~/.config/containers/systemd/step-ca-p11-kit@.volume`
- `~/.config/containers/systemd/step-ca-p11-kit.network`
- `~/.config/systemd/user/step-ca-p11-kit@.target`
- `~/.config/systemd/user/p11-kit-server@.service`
- `~/.config/systemd/user/p11-kit-server@.socket`
- `~/.config/systemd/user/p11-kit-server@.target`

Environment files are generated by upstream `generate-instance-env.sh`:

- Host `module-path` and token/key attributes are parsed from `step_ca_host_private_key_pkcs11_uri`.
- The in-container PKCS#11 client `module-path` is role-managed and fixed.
- step-ca listens on container port `9000`.
- `step_ca_https_port` controls the host-published port through generated drop-in config.

- `~/.config/p11-kit-server/<instance>.env`
- `~/.config/step-ca/<instance>.env`
- `~/.config/containers/systemd/step-ca-p11-kit@<instance>.container` -> `step-ca-p11-kit@.container`
- `~/.config/containers/systemd/step-ca-p11-kit@<instance>.container.d/10-publish-port.conf`
- Generated drop-in directory mode/owner/group: `0755`, `step`, `step` (or configured `step_user`, `step_group`)
- Generated drop-in file mode/owner/group: `0644`, `step`, `step` (or configured `step_user`, `step_group`)

When generated env and drop-in content changes, the role restarts:

- `p11-kit-server@<instance>.target`
- `step-ca-p11-kit@<instance>.service`

Use additional drop-ins (for example `20-*.conf`) for user-owned overrides.

The role starts and enables:

- `p11-kit-server@<instance>.target`
- `step-ca-p11-kit@<instance>.target`

## Example Playbook

```yaml
- hosts: ca_servers
  roles:
    - role: wtcross.step.step_host

    - role: wtcross.step.step_user
      vars:
        step_user: step
        step_group: step
        step_uid: 1001
        step_gid: 1001
        step_hsm_serial: "ABC123"
        step_hsm_vendor_id: "1050"
        step_hsm_product_id: "0407"

    - role: wtcross.step.step_ca
      vars:
        step_ca_name: "My CA"
        step_ca_dns_names:
          - "ca.example.com"
        step_ca_host_private_key_pkcs11_uri: "pkcs11:token=StepCA;id=%01;object=step-ca-key;type=private?module-path=/usr/lib64/pkcs11/opensc-pkcs11.so"
        step_ca_root_cert_local_path: "./certs/root.crt"
        step_ca_cert_local_path: "./certs/step-ca.crt"
        step_ca_https_port: 9000
```

## License

MIT-0
