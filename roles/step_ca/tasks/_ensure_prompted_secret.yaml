---
- name: Check if the podman secret for {{ _step_ca_prompted_secret_error_label }} exists
  become: true
  become_user: "{{ _step_user }}"
  ansible.builtin.command:
    cmd: "podman secret exists {{ _step_ca_prompted_secret_name }}-{{ _step_instance }}"
  register: __step_ca_prompted_secret_exists
  ignore_errors: true
  changed_when: false

- name: Fail when {{ _step_ca_prompted_secret_error_label }} podman secret check errors
  when: __step_ca_prompted_secret_exists.rc not in [0, 1]
  become: false
  ansible.builtin.fail:
    msg: >-
      Failed to check {{ _step_ca_prompted_secret_error_label }} podman secret state.
      Command output: {{ __step_ca_prompted_secret_exists.stderr | default('') }}

- name: Prompt for {{ _step_ca_prompted_secret_error_label }} when required
  when: __step_ca_prompted_secret_exists.rc == 1 or _step_ca_prompted_secret_force_prompt | bool
  become: false
  delegate_to: localhost
  no_log: true
  ansible.builtin.pause:
    prompt: "{{ _step_ca_prompted_secret_prompt }}"
    echo: false
  register: __step_ca_prompted_secret_prompt_result

- name: Validate prompted {{ _step_ca_prompted_secret_error_label }} value
  when:
    - __step_ca_prompted_secret_exists.rc == 1 or _step_ca_prompted_secret_force_prompt | bool
    - (__step_ca_prompted_secret_prompt_result.user_input | default('') | trim | length) == 0
  become: false
  delegate_to: localhost
  no_log: true
  ansible.builtin.fail:
    msg: >
      {{ _step_ca_prompted_secret_error_label }} prompt was requested but no value was provided.

- name: Remove existing {{ _step_ca_prompted_secret_error_label }} podman secret before forced replacement
  when:
    - _step_ca_prompted_secret_force_prompt | bool
    - __step_ca_prompted_secret_exists.rc == 0
  become: true
  become_user: "{{ _step_user }}"
  ansible.builtin.command:
    cmd: "podman secret rm {{ _step_ca_prompted_secret_name }}-{{ _step_instance }}"
  changed_when: true

- name: Create or replace podman secret for {{ _step_ca_prompted_secret_error_label }}
  when: __step_ca_prompted_secret_exists.rc == 1 or _step_ca_prompted_secret_force_prompt | bool
  become: true
  become_user: "{{ _step_user }}"
  no_log: true
  containers.podman.podman_secret:
    state: present
    name: "{{ _step_ca_prompted_secret_name }}-{{ _step_instance }}"
    data: "{{ __step_ca_prompted_secret_prompt_result.user_input }}"
    skip_existing: false
  notify: Restart step-ca quadlet service

- name: Clear prompted {{ _step_ca_prompted_secret_error_label }} value from memory
  become: false
  no_log: true
  ansible.builtin.set_fact:
    __step_ca_prompted_secret_prompt_result: null
  changed_when: false
