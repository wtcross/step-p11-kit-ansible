---
- name: Ensure p11-kit-server environment directory exists
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ __step_user_home }}/.config/p11-kit-server"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0750"

- name: Ensure step-ca environment directory exists
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ __step_user_home }}/.config/step-ca"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0750"

- name: Gather current instance config file checksums
  become: true
  ansible.builtin.stat:
    path: "{{ item }}"
  register: step_ca_env_before
  loop:
    - "{{ __step_user_home }}/.config/p11-kit-server/{{ _step_instance }}.env"
    - "{{ __step_user_home }}/.config/step-ca/{{ _step_instance }}.env"
    - "{{ __step_user_home }}/.config/containers/systemd/step-ca-p11-kit@{{ _step_instance }}.container.d/10-publish-port.conf"

- name: Generate instance env files using upstream helper script
  become: true
  become_user: "{{ _step_user }}"
  environment:
    HOME: "{{ __step_user_home }}"
  ansible.builtin.command:
    argv:
      - "{{ __step_ca_upstream_scripts_dir }}/generate-instance-env.sh"
      - --instance
      - "{{ _step_instance }}"
      - --ca-name
      - "{{ step_ca_name }}"
      - --dns
      - "{{ _step_ca_dns_names_csv | trim }}"
      - --external-port
      - "{{ _step_https_port }}"
      - --admin-subject
      - "{{ _step_ca_admin_subject }}"
      - --provisioner
      - "{{ _step_ca_admin_provisioner_name }}"
      - --steppath
      - "{{ _step_ca_steppath }}"
      - --hsm-module
      - "{{ __step_ca_host_pkcs11_module_path }}"
      - --hsm-uri
      - "{{ __step_ca_hsm_pkcs11_uri_derived }}"
      - --private-key-pkcs11-uri
      - "{{ __step_ca_private_key_pkcs11_uri_derived }}"
      - --force
  changed_when: false

- name: Gather generated instance quadlet artifact stats
  become: true
  ansible.builtin.stat:
    path: "{{ item.path }}"
    follow: false
  register: __step_ca_generated_quadlet_artifacts
  changed_when: false
  loop:
    - name: instanced quadlet source
      path: "{{ __step_user_home }}/.config/containers/systemd/step-ca-p11-kit@{{ _step_instance }}.container"
    - name: instance port drop-in directory
      path: "{{ __step_user_home }}/.config/containers/systemd/step-ca-p11-kit@{{ _step_instance }}.container.d"
    - name: instance port drop-in file
      path: "{{ __step_user_home }}/.config/containers/systemd/step-ca-p11-kit@{{ _step_instance }}.container.d/10-publish-port.conf"

- name: Fail when a generated instance quadlet artifact is missing
  when: not item.stat.exists
  become: false
  ansible.builtin.fail:
    msg: >-
      Expected generated instance quadlet artifact is missing:
      {{ item.item.path }}
  loop: "{{ __step_ca_generated_quadlet_artifacts.results }}"

- name: Fail when generated instanced quadlet source is not a symlink to template
  when: >-
    not (__step_ca_generated_quadlet_artifacts.results[0].stat.islnk | default(false))
    or
    (
      (__step_ca_generated_quadlet_artifacts.results[0].stat.lnk_target | default('')) != 'step-ca-p11-kit@.container'
      and
      (
        (__step_ca_generated_quadlet_artifacts.results[0].stat.lnk_source | default(''))
        | regex_search('/step-ca-p11-kit@\\.container$')
      ) is none
    )
  become: false
  ansible.builtin.fail:
    msg: >-
      Generated instanced quadlet source is not linked to step-ca-p11-kit@.container.
      path: {{ __step_ca_generated_quadlet_artifacts.results[0].item.path }}
      lnk_target: {{ __step_ca_generated_quadlet_artifacts.results[0].stat.lnk_target | default('') }}
      lnk_source: {{ __step_ca_generated_quadlet_artifacts.results[0].stat.lnk_source | default('') }}

- name: Fail when generated instance port drop-in directory has unexpected ownership or mode
  when: >-
    not (__step_ca_generated_quadlet_artifacts.results[1].stat.isdir | default(false))
    or (__step_ca_generated_quadlet_artifacts.results[1].stat.mode | default('')) != '0755'
    or (__step_ca_generated_quadlet_artifacts.results[1].stat.pw_name | default('')) != _step_user
    or (__step_ca_generated_quadlet_artifacts.results[1].stat.gr_name | default('')) != _step_group
  become: false
  ansible.builtin.fail:
    msg: >-
      Generated instance port drop-in directory metadata is unexpected.
      path: {{ __step_ca_generated_quadlet_artifacts.results[1].item.path }}
      mode: {{ __step_ca_generated_quadlet_artifacts.results[1].stat.mode | default('') }}
      owner: {{ __step_ca_generated_quadlet_artifacts.results[1].stat.pw_name | default('') }}
      group: {{ __step_ca_generated_quadlet_artifacts.results[1].stat.gr_name | default('') }}
      expected mode: 0755 owner: {{ _step_user }} group: {{ _step_group }}

- name: Fail when generated instance port drop-in file has unexpected ownership or mode
  when: >-
    not (__step_ca_generated_quadlet_artifacts.results[2].stat.isreg | default(false))
    or (__step_ca_generated_quadlet_artifacts.results[2].stat.mode | default('')) != '0644'
    or (__step_ca_generated_quadlet_artifacts.results[2].stat.pw_name | default('')) != _step_user
    or (__step_ca_generated_quadlet_artifacts.results[2].stat.gr_name | default('')) != _step_group
  become: false
  ansible.builtin.fail:
    msg: >-
      Generated instance port drop-in file metadata is unexpected.
      path: {{ __step_ca_generated_quadlet_artifacts.results[2].item.path }}
      mode: {{ __step_ca_generated_quadlet_artifacts.results[2].stat.mode | default('') }}
      owner: {{ __step_ca_generated_quadlet_artifacts.results[2].stat.pw_name | default('') }}
      group: {{ __step_ca_generated_quadlet_artifacts.results[2].stat.gr_name | default('') }}
      expected mode: 0644 owner: {{ _step_user }} group: {{ _step_group }}

- name: Gather instance config file checksums after regeneration
  become: true
  ansible.builtin.stat:
    path: "{{ item }}"
  register: step_ca_env_after
  loop:
    - "{{ __step_user_home }}/.config/p11-kit-server/{{ _step_instance }}.env"
    - "{{ __step_user_home }}/.config/step-ca/{{ _step_instance }}.env"
    - "{{ __step_user_home }}/.config/containers/systemd/step-ca-p11-kit@{{ _step_instance }}.container.d/10-publish-port.conf"

- name: Trigger restarts when regenerated instance config files changed
  become: false
  ansible.builtin.set_fact:
    __step_ca_env_files_changed: >-
      {{
        (step_ca_env_before.results[0].stat.checksum | default('')) !=
        (step_ca_env_after.results[0].stat.checksum | default('')) or
        (step_ca_env_before.results[1].stat.checksum | default('')) !=
        (step_ca_env_after.results[1].stat.checksum | default('')) or
        (step_ca_env_before.results[2].stat.checksum | default('')) !=
        (step_ca_env_after.results[2].stat.checksum | default(''))
      }}
  changed_when: __step_ca_env_files_changed | bool
  notify:
    - Restart the p11-kit-server target
    - Restart step-ca quadlet service

- name: Reload user-level systemd daemon before starting instance targets
  become: true
  become_user: "{{ _step_user }}"
  environment:
    XDG_RUNTIME_DIR: /run/user/{{ _step_uid }}
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ _step_uid }}/bus"
  ansible.builtin.command:
    argv:
      - systemctl
      - --user
      - daemon-reload
  changed_when: false

- name: Ensure instanced p11-kit-server target is enabled and started
  become: true
  become_user: "{{ _step_user }}"
  environment:
    XDG_RUNTIME_DIR: /run/user/{{ _step_uid }}
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ _step_uid }}/bus"
  ansible.builtin.systemd_service:
    state: started
    enabled: true
    scope: user
    name: "p11-kit-server@{{ _step_instance }}.target"

- name: Ensure step-ca-p11-kit instance target is enabled and started
  become: true
  become_user: "{{ _step_user }}"
  environment:
    XDG_RUNTIME_DIR: /run/user/{{ _step_uid }}
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ _step_uid }}/bus"
  ansible.builtin.systemd_service:
    state: started
    enabled: true
    scope: user
    name: "step-ca-p11-kit@{{ _step_instance }}.target"

- name: Verify step-ca container publishes the expected host port
  become: true
  become_user: "{{ _step_user }}"
  environment:
    XDG_RUNTIME_DIR: /run/user/{{ _step_uid }}
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ _step_uid }}/bus"
  ansible.builtin.command:
    argv:
      - podman
      - port
      - "step-ca-{{ _step_instance }}"
      - "9000/tcp"
  register: step_ca_published_ports
  changed_when: false
  failed_when: >-
    step_ca_published_ports.rc != 0 or
    (
      step_ca_published_ports.stdout_lines |
      select('search', '(^|:)' ~ _step_https_port ~ '$') |
      list |
      length
    ) == 0
