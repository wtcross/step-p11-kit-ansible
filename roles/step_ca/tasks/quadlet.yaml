---
- name: Ensure p11-kit-server environment directory exists
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ __step_user_home }}/.config/p11-kit-server"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0750"

- name: Ensure step-ca environment directory exists
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ __step_user_home }}/.config/step-ca"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0750"

- name: Read existing step-ca data volume mountpoint
  become: true
  become_user: "{{ _step_user }}"
  environment:
    HOME: "{{ __step_user_home }}"
  ansible.builtin.command:
    argv:
      - podman
      - volume
      - inspect
      - --format
      - "{{ '{{ .Mountpoint }}' }}"
      - "step-ca-p11-kit-{{ _step_instance }}-data"
  register: __step_ca_data_volume_mountpoint_cmd
  failed_when: false
  changed_when: false

- name: Normalize existing step-ca data volume mountpoint
  become: false
  ansible.builtin.set_fact:
    __step_ca_data_volume_mountpoint: >-
      {{
        (__step_ca_data_volume_mountpoint_cmd.stdout | default('') | trim)
        if __step_ca_data_volume_mountpoint_cmd.rc == 0
        else ''
      }}
  changed_when: false

- name: Check for persisted step-ca config in existing data volume
  when: __step_ca_data_volume_mountpoint | length > 0
  become: true
  ansible.builtin.stat:
    path: "{{ __step_ca_data_volume_mountpoint }}/config/ca.json"
  register: __step_ca_existing_ca_config_stat
  changed_when: false

- name: Read persisted step-ca config from existing data volume
  when: __step_ca_existing_ca_config_stat.stat.exists | default(false)
  become: true
  ansible.builtin.slurp:
    src: "{{ __step_ca_data_volume_mountpoint }}/config/ca.json"
  register: __step_ca_existing_ca_config
  changed_when: false

- name: Extract persisted step-ca listener address
  when: __step_ca_existing_ca_config is defined
  become: false
  ansible.builtin.set_fact:
    __step_ca_existing_ca_address: >-
      {{
        (
          __step_ca_existing_ca_config.content
          | b64decode
          | regex_findall('"address"\\s*:\\s*"([^"]+)"')
          | first
        )
        | default('')
        | trim
      }}
  changed_when: false

- name: Extract persisted step-ca listener port
  when: __step_ca_existing_ca_address | default('') | length > 0
  become: false
  ansible.builtin.set_fact:
    __step_ca_existing_ca_listener_port: >-
      {{
        (
          __step_ca_existing_ca_address
          | regex_findall('([0-9]+)$')
          | first
        )
        | default('')
        | trim
      }}
  changed_when: false

- name: Determine effective step-ca container HTTPS port
  become: false
  ansible.builtin.set_fact:
    __step_ca_effective_container_https_port: >-
      {{
        (__step_ca_existing_ca_listener_port | default('') | trim)
        if (__step_ca_existing_ca_listener_port | default('') | trim | length > 0)
        else __step_ca_container_https_port
      }}
  changed_when: false

- name: Warn when existing step-ca instance uses non-default internal HTTPS port
  when:
    - __step_ca_existing_ca_listener_port | default('') | trim | length > 0
    - __step_ca_existing_ca_listener_port != __step_ca_container_https_port
  become: false
  ansible.builtin.debug:
    msg: >-
      Existing step-ca instance {{ _step_instance }} uses internal listener port
      {{ __step_ca_existing_ca_listener_port }} from persisted ca.json.
      This role preserves existing listener ports; new instances default to
      {{ __step_ca_container_https_port }}.
  changed_when: false

- name: Gather current env file checksums
  become: true
  ansible.builtin.stat:
    path: "{{ item }}"
  register: step_ca_env_before
  loop:
    - "{{ __step_user_home }}/.config/p11-kit-server/{{ _step_instance }}.env"
    - "{{ __step_user_home }}/.config/step-ca/{{ _step_instance }}.env"

- name: Generate instance env files using upstream helper script
  become: true
  become_user: "{{ _step_user }}"
  environment:
    HOME: "{{ __step_user_home }}"
  ansible.builtin.command:
    argv:
      - "{{ __step_ca_upstream_scripts_dir }}/generate-instance-env.sh"
      - --instance
      - "{{ _step_instance }}"
      - --ca-name
      - "{{ step_ca_name }}"
      - --dns
      - "{{ _step_ca_dns_names_csv | trim }}"
      - --address
      - ":{{ __step_ca_effective_container_https_port }}"
      - --admin-subject
      - "{{ _step_ca_admin_subject }}"
      - --provisioner
      - "{{ _step_ca_admin_provisioner_name }}"
      - --steppath
      - "{{ _step_ca_steppath }}"
      - --hsm-module
      - "{{ __step_ca_host_pkcs11_module_path }}"
      - --hsm-uri
      - "{{ __step_ca_hsm_pkcs11_uri_derived }}"
      - --private-key-pkcs11-uri
      - "{{ __step_ca_private_key_pkcs11_uri_derived }}"
      - --kms-pkcs11-uri
      - "{{ __step_ca_kms_pkcs11_uri_derived }}"
      - --force
  changed_when: false

- name: Gather env file checksums after regeneration
  become: true
  ansible.builtin.stat:
    path: "{{ item }}"
  register: step_ca_env_after
  loop:
    - "{{ __step_user_home }}/.config/p11-kit-server/{{ _step_instance }}.env"
    - "{{ __step_user_home }}/.config/step-ca/{{ _step_instance }}.env"

- name: Trigger restarts when regenerated env files changed
  become: false
  ansible.builtin.set_fact:
    __step_ca_env_files_changed: >-
      {{
        (step_ca_env_before.results[0].stat.checksum | default('')) !=
        (step_ca_env_after.results[0].stat.checksum | default('')) or
        (step_ca_env_before.results[1].stat.checksum | default('')) !=
        (step_ca_env_after.results[1].stat.checksum | default(''))
      }}
  changed_when: __step_ca_env_files_changed | bool
  notify:
    - Restart the p11-kit-server target
    - Restart step-ca quadlet service

- name: Ensure step-ca instanced quadlet source symlink exists
  become: true
  ansible.builtin.file:
    state: link
    path: "{{ __step_user_home }}/.config/containers/systemd/step-ca-p11-kit@{{ _step_instance }}.container"
    src: step-ca-p11-kit@.container
    force: true
    follow: false
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
  notify:
    - Reload the user-level systemd daemon
    - Restart step-ca quadlet service

- name: Ensure step-ca container drop-in directory exists
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ __step_user_home }}/.config/containers/systemd/step-ca-p11-kit@{{ _step_instance }}.container.d"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0755"

- name: Ensure step-ca port configuration drop-in exists
  become: true
  ansible.builtin.copy:
    dest: "{{ __step_user_home }}/.config/containers/systemd/step-ca-p11-kit@{{ _step_instance }}.container.d/10-ports.conf"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0644"
    content: |
      [Container]
      PublishPort={{ _step_https_port }}:{{ __step_ca_effective_container_https_port }}
  notify:
    - Reload the user-level systemd daemon
    - Restart step-ca quadlet service

- name: Ensure template-level step-ca port drop-in is absent
  become: true
  ansible.builtin.file:
    state: absent
    path: "{{ __step_user_home }}/.config/containers/systemd/step-ca-p11-kit@.container.d/10-ports.conf"
  notify:
    - Reload the user-level systemd daemon
    - Restart step-ca quadlet service

- name: Reload user-level systemd daemon before starting instance targets
  become: true
  become_user: "{{ _step_user }}"
  environment:
    XDG_RUNTIME_DIR: /run/user/{{ _step_uid }}
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ _step_uid }}/bus"
  ansible.builtin.command:
    argv:
      - systemctl
      - --user
      - daemon-reload
  changed_when: false

- name: Generate quadlet units in dry-run mode for instance drop-in validation
  become: true
  become_user: "{{ _step_user }}"
  environment:
    XDG_RUNTIME_DIR: /run/user/{{ _step_uid }}
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ _step_uid }}/bus"
  ansible.builtin.command:
    argv:
      - /usr/lib/systemd/system-generators/podman-system-generator
      - --user
      - --dryrun
  register: step_ca_quadlet_generator_dryrun
  changed_when: false

- name: Fail when quadlet dry-run does not include expected instance publish mapping
  when: >-
    ('---step-ca-p11-kit@' ~ _step_instance ~ '.service---')
    not in (step_ca_quadlet_generator_dryrun.stdout ~ '\n' ~ step_ca_quadlet_generator_dryrun.stderr)
    or
    ('--publish ' ~ _step_https_port ~ ':' ~ __step_ca_effective_container_https_port)
    not in (step_ca_quadlet_generator_dryrun.stdout ~ '\n' ~ step_ca_quadlet_generator_dryrun.stderr)
  become: false
  ansible.builtin.fail:
    msg: >-
      Quadlet dry-run did not generate the expected instance service publish mapping for
      step-ca-p11-kit@{{ _step_instance }}. Expected to find --publish {{ _step_https_port }}:{{ __step_ca_effective_container_https_port }}
      in generator output.

- name: Ensure instanced p11-kit-server target is enabled and started
  become: true
  become_user: "{{ _step_user }}"
  environment:
    XDG_RUNTIME_DIR: /run/user/{{ _step_uid }}
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ _step_uid }}/bus"
  ansible.builtin.systemd_service:
    state: started
    enabled: true
    scope: user
    name: "p11-kit-server@{{ _step_instance }}.target"

- name: Ensure step-ca-p11-kit instance target is enabled and started
  become: true
  become_user: "{{ _step_user }}"
  environment:
    XDG_RUNTIME_DIR: /run/user/{{ _step_uid }}
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ _step_uid }}/bus"
  ansible.builtin.systemd_service:
    state: started
    enabled: true
    scope: user
    name: "step-ca-p11-kit@{{ _step_instance }}.target"

- name: Verify step-ca container publishes the expected host port
  become: true
  become_user: "{{ _step_user }}"
  environment:
    XDG_RUNTIME_DIR: /run/user/{{ _step_uid }}
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ _step_uid }}/bus"
  ansible.builtin.command:
    argv:
      - podman
      - port
      - "step-ca-{{ _step_instance }}"
      - "{{ __step_ca_effective_container_https_port }}/tcp"
  register: step_ca_published_ports
  changed_when: false
  failed_when: >-
    step_ca_published_ports.rc != 0 or
    (
      step_ca_published_ports.stdout_lines |
      select('search', '(^|:)' ~ _step_https_port ~ '$') |
      list |
      length
    ) == 0
