---
- name: Check if {{ _step_ca_cert_secret_name }} podman secret exists
  become: true
  become_user: "{{ _step_user }}"
  ansible.builtin.command:
    cmd: "podman secret exists {{ _step_ca_cert_secret_name }}-{{ _step_instance }}"
  register: __step_ca_cert_secret_exists
  ignore_errors: true
  changed_when: false

- name: Fail when {{ _step_ca_cert_secret_name }} podman secret check errors
  when: __step_ca_cert_secret_exists.rc not in [0, 1]
  become: false
  ansible.builtin.fail:
    msg: >-
      Failed to check {{ _step_ca_cert_secret_name }} podman secret state.
      Command output: {{ __step_ca_cert_secret_exists.stderr | default('') }}

- name: Check if {{ _step_ca_cert_secret_name }} checksum marker exists
  become: true
  ansible.builtin.stat:
    path: "{{ __step_ca_secret_state_dir }}/{{ _step_ca_cert_secret_name }}-{{ _step_instance }}.sha256"
  register: __step_ca_cert_secret_checksum_marker

- name: Read previous {{ _step_ca_cert_secret_name }} checksum marker
  when: __step_ca_cert_secret_checksum_marker.stat.exists
  become: true
  ansible.builtin.slurp:
    src: "{{ __step_ca_secret_state_dir }}/{{ _step_ca_cert_secret_name }}-{{ _step_instance }}.sha256"
  register: __step_ca_cert_secret_checksum_marker_content

- name: Determine previous {{ _step_ca_cert_secret_name }} checksum
  become: false
  ansible.builtin.set_fact:
    __step_ca_cert_secret_previous_checksum: >-
      {{
        (__step_ca_cert_secret_checksum_marker_content.content | default('') | b64decode | trim)
        if __step_ca_cert_secret_checksum_marker.stat.exists
        else ''
      }}
  changed_when: false

- name: Determine {{ _step_ca_cert_secret_name }} update requirements
  become: false
  ansible.builtin.set_fact:
    __step_ca_cert_secret_needs_update: >-
      {{
        (__step_ca_cert_secret_exists.rc == 1) or
        (
          (step_ca_rotate_cert_secrets | bool) and
          (__step_ca_cert_secret_previous_checksum != _step_ca_cert_secret_checksum)
        )
      }}
  changed_when: false

- name: Remove existing {{ _step_ca_cert_secret_name }} podman secret before rotation
  when: __step_ca_cert_secret_needs_update | bool
  become: true
  become_user: "{{ _step_user }}"
  ansible.builtin.command:
    cmd: "podman secret rm {{ _step_ca_cert_secret_name }}-{{ _step_instance }}"
  register: __step_ca_remove_cert_secret
  failed_when: false
  changed_when: __step_ca_remove_cert_secret.rc == 0

- name: Create or replace {{ _step_ca_cert_secret_name }} podman secret
  when: __step_ca_cert_secret_needs_update | bool
  become: true
  become_user: "{{ _step_user }}"
  containers.podman.podman_secret:
    state: present
    name: "{{ _step_ca_cert_secret_name }}-{{ _step_instance }}"
    data: "{{ lookup('ansible.builtin.file', _step_ca_cert_secret_source_path) }}"
    skip_existing: false
  notify: Restart step-ca quadlet service

- name: Record {{ _step_ca_cert_secret_name }} checksum marker
  when: __step_ca_cert_secret_needs_update | bool
  become: true
  ansible.builtin.copy:
    dest: "{{ __step_ca_secret_state_dir }}/{{ _step_ca_cert_secret_name }}-{{ _step_instance }}.sha256"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0600"
    content: "{{ _step_ca_cert_secret_checksum }}\n"
